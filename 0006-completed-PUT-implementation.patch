From 56632fe49a942ab63868acc9e31fbdb2254fb8f9 Mon Sep 17 00:00:00 2001
From: Samik Shrotriya <ss2659@cornell.edu>
Date: Thu, 18 Jul 2019 10:17:46 -0400
Subject: [PATCH 6/9] completed PUT implementation

---
 .DS_Store         | Bin 0 -> 6148 bytes
 clients.db        | Bin 8192 -> 8192 bytes
 package-lock.json |  41 ++++++++++++++++++++++++++++++-----------
 server.js         |  36 ++++++++++++++++++++++++++++++++----
 4 files changed, 62 insertions(+), 15 deletions(-)
 create mode 100644 .DS_Store

diff --git a/.DS_Store b/.DS_Store
new file mode 100644
index 0000000000000000000000000000000000000000..88bed5d2a6d5d839c7961075035f66a5e2242460
GIT binary patch
literal 6148
zcmeHKyH3ME5S)b+k)TLPdB4CPoTBgrd;kcXF5n_c?~3orr!o5w!g7#kXwa;*J9q1y
zJ9!GP7l3U~!#%J8u%<iW!^6`2x%<MdDq}=C&v?QcMhrONu&BPAaPBSMgSDUW_c#v6
z*Tc&={`RcPHz+Fwq<|EV0#ZN<d{@AGFKvC3s3--bfE4&rz`qZT?$`^b#Q1bD#0WrK
zF&)Nr%o4=r31Tmt5}Bb{Qi(~m8Zj*C%(trRg;QeEVKsbM-E1|XSlrI@Ta?3kqM{U#
z0&@kfbGz~W|3Lp?{-2YylLAuUUnyX#-Q#Y{SE}B+cscL2js8scnls&v>!2`1J0?au
h=EmFcT@+<q^EIFM!YMK6%m<yQp8?lJCI$XlflrXF7HR+h

literal 0
HcmV?d00001

diff --git a/clients.db b/clients.db
index 8ba54853a51784d74beb91f9096afc1675c427ea..5e63cabfb8f5956453ae5876638a77a5ace3ff60 100644
GIT binary patch
delta 142
zcmV;90CE3-K!8Ay8v#v`976$3v0$MO9StV{6bd;63V08@4{i@E4x$e64jK*L4Vw*Q
z3OTbL5E}}UCLKNj4YPO}t^x@U4rl;9BT*d*lP(=Kvt%6u0SONd>Hs<^M;i%~Zyqv}
wq8>{G2PIJ>lV=_~lfEB92ulM703UT50h2QyL<s^z0tNsbWgP*Ne;+&n0@UasCjbBd

delta 123
zcmV->0EGX5K!8Ay8v#0z976#*v0$MO9S-UM6bg6*3V0894=WG84x$cc4jK*L4Vw*Q
z4JNZ55E}}SfIa~avv?Y=0+Tr!KC@&U0|Arq9y^nw9!mv5B~c>@lQbVW2ucG603UT5
d36pjoL<m9x1^^vp9SM`eA3Os9005ILA3_lo9~%Gw

diff --git a/package-lock.json b/package-lock.json
index 9719cfc..c15142f 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -2483,7 +2483,8 @@
         "ansi-regex": {
           "version": "2.1.1",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "aproba": {
           "version": "1.2.0",
@@ -2504,12 +2505,14 @@
         "balanced-match": {
           "version": "1.0.0",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "brace-expansion": {
           "version": "1.1.11",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "balanced-match": "^1.0.0",
             "concat-map": "0.0.1"
@@ -2524,17 +2527,20 @@
         "code-point-at": {
           "version": "1.1.0",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "concat-map": {
           "version": "0.0.1",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "console-control-strings": {
           "version": "1.1.0",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "core-util-is": {
           "version": "1.0.2",
@@ -2651,7 +2657,8 @@
         "inherits": {
           "version": "2.0.3",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "ini": {
           "version": "1.3.5",
@@ -2663,6 +2670,7 @@
           "version": "1.0.0",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "number-is-nan": "^1.0.0"
           }
@@ -2677,6 +2685,7 @@
           "version": "3.0.4",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "brace-expansion": "^1.1.7"
           }
@@ -2684,12 +2693,14 @@
         "minimist": {
           "version": "0.0.8",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "minipass": {
           "version": "2.3.5",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "safe-buffer": "^5.1.2",
             "yallist": "^3.0.0"
@@ -2708,6 +2719,7 @@
           "version": "0.5.1",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "minimist": "0.0.8"
           }
@@ -2788,7 +2800,8 @@
         "number-is-nan": {
           "version": "1.0.1",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "object-assign": {
           "version": "4.1.1",
@@ -2800,6 +2813,7 @@
           "version": "1.4.0",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "wrappy": "1"
           }
@@ -2885,7 +2899,8 @@
         "safe-buffer": {
           "version": "5.1.2",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "safer-buffer": {
           "version": "2.1.2",
@@ -2921,6 +2936,7 @@
           "version": "1.0.2",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "code-point-at": "^1.0.0",
             "is-fullwidth-code-point": "^1.0.0",
@@ -2940,6 +2956,7 @@
           "version": "3.0.1",
           "bundled": true,
           "dev": true,
+          "optional": true,
           "requires": {
             "ansi-regex": "^2.0.0"
           }
@@ -2983,12 +3000,14 @@
         "wrappy": {
           "version": "1.0.2",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         },
         "yallist": {
           "version": "3.0.3",
           "bundled": true,
-          "dev": true
+          "dev": true,
+          "optional": true
         }
       }
     },
diff --git a/server.js b/server.js
index 7ba16d7..4c95afd 100644
--- a/server.js
+++ b/server.js
@@ -53,15 +53,15 @@ const validateId = (id) => {
 const validatePriority = (priority) => {
   if (Number.isNaN(priority)) {
     return {
-      valid: false,
-      messageObj: {
+      valid1: false,
+      messageObj1: {
       'message': 'Invalid priority provided.',
       'long_message': 'Priority can only be positive integer.',
       },
     };
   }
   return {
-    valid: true,
+    valid1: true,
   }
 }
 
@@ -121,15 +121,43 @@ app.put('/api/v1/clients/:id', (req, res) => {
     res.status(400).send(messageObj);
   }
 
+  const { valid1, messageObj1 } = validatePriority(priority);
+  if (!valid1) {
+    res.status(400).send(messageObj1);
+  }
+
   let { status, priority } = req.body;
   let clients = db.prepare('select * from clients').all();
   const client = clients.find(client => client.id === id);
 
   /* ---------- Update code below ----------*/
 
+  if(priority){
+    const cli = db.prepare('select * from clients where status = ? and priority = ? limit 1').get([status, priority]);
+    
+    if(!cli){
+      const stmt = db.prepare('update clients set priority = ? where id = ?')
+      stmt.run([priority, client.id])
+    } else {
+      if (priority < client.priority){
+        const increment = db.prepare('update clients set priority = priority + 1 where priority >= ? and priority < ?')
+        increment.run([priority, client.priority])
+      } else if (priority > client.priority) {
+        const decrement = db.prepare('update clients set priority = priority - 1 where priority <= ? and priority > ?')
+        decrement.run([priority, client.priority])
+      }
+      const stmt = db.prepare('update clients set priority = ? where id = ?')
+      stmt.run([priority, client.id])
+    } 
+  }
 
+  if(status){
+    const stmt = db.prepare('update clients set status = ? where id = ?')
+    stmt.run([status, client.id])
+  }
 
-  return res.status(200).send(clients);
+  let clis = db.prepare('select * from clients').all();
+  return res.status(200).send(clis);
 });
 
 app.listen(3001);
-- 
2.17.2 (Apple Git-113)

